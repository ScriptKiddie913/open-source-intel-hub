import { useState, useEffect, useRef } from 'react';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { Input } from '@/components/ui/input';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';
import { ScrollArea } from '@/components/ui/scroll-area';
import { Separator } from '@/components/ui/separator';
import { Alert, AlertDescription } from '@/components/ui/alert';
import { malwareApi } from '@/services/malwareApi';
import { MalwareSample, MalwareAnalysis } from '@/types/malware';
import {
  Search,
  AlertTriangle,
  Shield,
  FileWarning,
  Activity,
  Hash,
  Users,
  TrendingUp,
  Loader2,
  Database,
  Brain,
  FileSearch,
  RefreshCw,
  Clock,
  Zap,
} from 'lucide-react';

const AUTO_REFRESH_INTERVAL = 5 * 60 * 1000; // 5 minutes
const DISPLAY_LIMIT = 100;

export function MalwareIntelligence() {
  const [searchQuery, setSearchQuery] = useState('');
  const [loading, setLoading] = useState(false);
  const [autoRefreshing, setAutoRefreshing] = useState(true);
  const [recentSamples, setRecentSamples] = useState<MalwareSample[]>([]);
  const [searchResults, setSearchResults] = useState<MalwareSample[]>([]);
  const [selectedSample, setSelectedSample] = useState<MalwareSample | null>(null);
  const [analysis, setAnalysis] = useState<MalwareAnalysis | null>(null);
  const [familyStats, setFamilyStats] = useState<Map<string, number>>(new Map());
  const [activeTab, setActiveTab] = useState('dashboard');
  const [lastUpdate, setLastUpdate] = useState<Date>(new Date());
  const [nextUpdate, setNextUpdate] = useState<Date>(new Date(Date.now() + AUTO_REFRESH_INTERVAL));
  const refreshTimerRef = useRef<NodeJS.Timeout | null>(null);
  const countdownTimerRef = useRef<NodeJS.Timeout | null>(null);

  // Initial load
  useEffect(() => {
    loadAllData();
  }, []);

  // Auto-refresh mechanism
  useEffect(() => {
    if (! autoRefreshing) {
      if (refreshTimerRef.current) clearInterval(refreshTimerRef.current);
      if (countdownTimerRef.current) clearInterval(countdownTimerRef.current);
      return;
    }

    // Main refresh timer
    refreshTimerRef.current = setInterval(() => {
      loadAllData();
    }, AUTO_REFRESH_INTERVAL);

    // Countdown update timer (updates every second)
    countdownTimerRef.current = setInterval(() => {
      setNextUpdate(new Date(Date.now() + AUTO_REFRESH_INTERVAL));
    }, 1000);

    return () => {
      if (refreshTimerRef. current) clearInterval(refreshTimerRef.current);
      if (countdownTimerRef.current) clearInterval(countdownTimerRef.current);
    };
  }, [autoRefreshing]);

  const loadAllData = async () => {
    setLoading(true);
    try {
      await Promise.all([
        loadRecentSamples(),
        loadFamilyStats(),
      ]);
      setLastUpdate(new Date());
      setNextUpdate(new Date(Date.now() + AUTO_REFRESH_INTERVAL));
    } catch (error) {
      console.error('Error loading data:', error);
    } finally {
      setLoading(false);
    }
  };

  const loadRecentSamples = async () => {
    try {
      const samples = await malwareApi.getRecentSamples(DISPLAY_LIMIT);
      setRecentSamples(samples);
    } catch (error) {
      console.error('Error loading samples:', error);
    }
  };

  const loadFamilyStats = async () => {
    try {
      const stats = await malwareApi.getMalwareFamilies();
      setFamilyStats(stats);
    } catch (error) {
      console.error('Error loading family stats:', error);
    }
  };

  const handleSearch = async () => {
    if (!searchQuery.trim()) return;
    
    setLoading(true);
    try {
      // Try hash search first
      if (searchQuery.length === 32 || searchQuery.length === 40 || searchQuery.length === 64) {
        const result = await malwareApi.searchByHash(searchQuery);
        setSearchResults(result ?  [result] : []);
      } else {
        // Search by family/signature
        const results = await malwareApi.searchBySignature(searchQuery);
        setSearchResults(results);
      }
      setActiveTab('search');
    } catch (error) {
      console.error('Error searching:', error);
    } finally {
      setLoading(false);
    }
  };

  const handleAnalyze = async (sample: MalwareSample) => {
    setSelectedSample(sample);
    setLoading(true);
    try {
      const result = await malwareApi.analyzeWithAI(sample. hashes. sha256);
      setAnalysis(result);
      setActiveTab('analysis');
    } catch (error) {
      console.error('Error analyzing:', error);
    } finally {
      setLoading(false);
    }
  };

  const getThreatLevelColor = (level: string) => {
    switch (level) {
      case 'critical':  return 'destructive';
      case 'high': return 'destructive';
      case 'medium': return 'default';
      case 'low': return 'secondary';
      default: return 'secondary';
    }
  };

  const getTimeUntilRefresh = () => {
    const diff = nextUpdate.getTime() - Date.now();
    if (diff <= 0) return '0:00';
    const minutes = Math.floor(diff / 60000);
    const seconds = Math.floor((diff % 60000) / 1000);
    return `${minutes}:${seconds.toString().padStart(2, '0')}`;
  };

  const topFamilies = Array.from(familyStats.entries())
    .sort((a, b) => b[1] - a[1])
    .slice(0, 10);

  const criticalCount = recentSamples.filter(s => s.threatLevel === 'critical').length;
  const highCount = recentSamples.filter(s => s.threatLevel === 'high').length;

  return (
    <div className="space-y-6 p-6">
      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-3xl font-bold flex items-center gap-2">
            <Shield className="h-8 w-8 text-red-500" />
            Malware Intelligence Hub
          </h1>
          <p className="text-muted-foreground mt-1">
            Real-time malware tracking from MalwareBazaar, ThreatFox & URLhaus
          </p>
        </div>
        <div className="flex items-center gap-3">
          {/* Auto-refresh Toggle */}
          <Button
            onClick={() => setAutoRefreshing(! autoRefreshing)}
            variant={autoRefreshing ? 'default' : 'outline'}
            size="sm"
          >
            <Zap className={`mr-2 h-4 w-4 ${autoRefreshing ? 'animate-pulse' : ''}`} />
            {autoRefreshing ? 'Auto-Refresh ON' : 'Auto-Refresh OFF'}
          </Button>

          {/* Manual Refresh */}
          <Button onClick={loadAllData} variant="outline" disabled={loading}>
            <RefreshCw className={`mr-2 h-4 w-4 ${loading ?  'animate-spin' : ''}`} />
            Refresh Now
          </Button>
        </div>
      </div>

      {/* Status Bar */}
      <Card className="bg-secondary/20">
        <CardContent className="pt-6">
          <div className="grid grid-cols-3 gap-4 text-sm">
            <div className="flex items-center gap-2">
              <Clock className="h-4 w-4 text-muted-foreground" />
              <div>
                <div className="font-medium">Last Updated</div>
                <div className="text-xs text-muted-foreground">
                  {lastUpdate.toLocaleTimeString()}
                </div>
              </div>
            </div>
            
            {autoRefreshing && (
              <div className="flex items-center gap-2">
                <RefreshCw className="h-4 w-4 text-green-500 animate-pulse" />
                <div>
                  <div className="font-medium">Next Refresh</div>
                  <div className="text-xs text-muted-foreground font-mono">
                    {getTimeUntilRefresh()}
                  </div>
                </div>
              </div>
            )}

            <div className="flex items-center gap-2">
              <Activity className="h-4 w-4 text-blue-500" />
              <div>
                <div className="font-medium">Live Monitoring</div>
                <div className="text-xs text-green-500">● Active</div>
              </div>
            </div>
          </div>
        </CardContent>
      </Card>

      {/* Search Bar */}
      <Card>
        <CardContent className="pt-6">
          <div className="flex gap-2">
            <div className="relative flex-1">
              <Search className="absolute left-3 top-3 h-4 w-4 text-muted-foreground" />
              <Input
                placeholder="Search by hash (MD5/SHA1/SHA256) or malware family name..."
                value={searchQuery}
                onChange={(e) => setSearchQuery(e.target.value)}
                onKeyDown={(e) => e.key === 'Enter' && handleSearch()}
                className="pl-10"
              />
            </div>
            <Button onClick={handleSearch} disabled={loading}>
              {loading ? <Loader2 className="mr-2 h-4 w-4 animate-spin" /> : <FileSearch className="mr-2 h-4 w-4" />}
              Search
            </Button>
          </div>
        </CardContent>
      </Card>

      {/* Main Tabs */}
      <Tabs value={activeTab} onValueChange={setActiveTab}>
        <TabsList className="grid w-full grid-cols-4">
          <TabsTrigger value="dashboard">Dashboard</TabsTrigger>
          <TabsTrigger value="recent">
            Recent Samples
            {recentSamples.length > 0 && (
              <Badge variant="secondary" className="ml-2">
                {recentSamples.length}
              </Badge>
            )}
          </TabsTrigger>
          <TabsTrigger value="search">Search Results</TabsTrigger>
          <TabsTrigger value="analysis">Analysis</TabsTrigger>
        </TabsList>

        {/* Dashboard Tab */}
        <TabsContent value="dashboard" className="space-y-4">
          <div className="grid gap-4 md:grid-cols-2 lg:grid-cols-4">
            <Card>
              <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                <CardTitle className="text-sm font-medium">Total Samples</CardTitle>
                <Database className="h-4 w-4 text-muted-foreground" />
              </CardHeader>
              <CardContent>
                <div className="text-2xl font-bold">{recentSamples.length}</div>
                <p className="text-xs text-muted-foreground">Recent submissions</p>
              </CardContent>
            </Card>

            <Card>
              <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                <CardTitle className="text-sm font-medium">Malware Families</CardTitle>
                <TrendingUp className="h-4 w-4 text-muted-foreground" />
              </CardHeader>
              <CardContent>
                <div className="text-2xl font-bold">{familyStats.size}</div>
                <p className="text-xs text-muted-foreground">Unique families detected</p>
              </CardContent>
            </Card>

            <Card>
              <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                <CardTitle className="text-sm font-medium">Critical Threats</CardTitle>
                <AlertTriangle className="h-4 w-4 text-red-500" />
              </CardHeader>
              <CardContent>
                <div className="text-2xl font-bold text-red-500">{criticalCount}</div>
                <p className="text-xs text-muted-foreground">Requiring immediate attention</p>
              </CardContent>
            </Card>

            <Card>
              <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                <CardTitle className="text-sm font-medium">High Severity</CardTitle>
                <Shield className="h-4 w-4 text-orange-500" />
              </CardHeader>
              <CardContent>
                <div className="text-2xl font-bold text-orange-500">{highCount}</div>
                <p className="text-xs text-muted-foreground">Active monitoring required</p>
              </CardContent>
            </Card>
          </div>

          {/* Top Malware Families */}
          <Card>
            <CardHeader>
              <CardTitle>Top Malware Families</CardTitle>
              <CardDescription>Most prevalent malware families in recent samples</CardDescription>
            </CardHeader>
            <CardContent>
              <ScrollArea className="h-[400px]">
                <div className="space-y-4">
                  {topFamilies.length === 0 ? (
                    <Alert>
                      <AlertDescription>Loading malware family data...</AlertDescription>
                    </Alert>
                  ) : (
                    topFamilies.map(([family, count], index) => (
                      <div key={family} className="flex items-center justify-between">
                        <div className="flex items-center gap-3">
                          <span className="font-mono text-sm text-muted-foreground w-8">#{index + 1}</span>
                          <div>
                            <p className="font-medium">{family}</p>
                            <p className="text-sm text-muted-foreground">{count} samples detected</p>
                          </div>
                        </div>
                        <Button
                          variant="ghost"
                          size="sm"
                          onClick={() => {
                            setSearchQuery(family);
                            handleSearch();
                          }}
                        >
                          View Details
                        </Button>
                      </div>
                    ))
                  )}
                </div>
              </ScrollArea>
            </CardContent>
          </Card>

          {/* Real-time Activity Feed */}
          <Card>
            <CardHeader>
              <CardTitle className="flex items-center gap-2">
                <Activity className="h-5 w-5 text-green-500 animate-pulse" />
                Real-Time Activity
              </CardTitle>
              <CardDescription>Latest malware submissions from abuse.ch sources</CardDescription>
            </CardHeader>
            <CardContent>
              <ScrollArea className="h-[300px]">
                <div className="space-y-2">
                  {recentSamples.slice(0, 15).map((sample) => (
                    <div key={sample.id} className="flex items-center justify-between p-2 rounded-lg border">
                      <div className="flex items-center gap-2">
                        <FileWarning className="h-4 w-4 text-red-500" />
                        <div>
                          <p className="text-sm font-medium">{sample.family}</p>
                          <p className="text-xs text-muted-foreground font-mono">
                            {sample.hashes.sha256.substring(0, 16)}...
                          </p>
                        </div>
                      </div>
                      <div className="flex items-center gap-2">
                        <Badge variant={getThreatLevelColor(sample.threatLevel)} className="text-xs">
                          {sample.threatLevel}
                        </Badge>
                        <span className="text-xs text-muted-foreground">
                          {new Date(sample.firstSeen).toLocaleTimeString()}
                        </span>
                      </div>
                    </div>
                  ))}
                </div>
              </ScrollArea>
            </CardContent>
          </Card>
        </TabsContent>

        {/* Recent Samples Tab */}
        <TabsContent value="recent" className="space-y-4">
          <Card>
            <CardHeader>
              <CardTitle>Recent Malware Samples</CardTitle>
              <CardDescription>
                Latest {recentSamples.length} malware submissions from MalwareBazaar
              </CardDescription>
            </CardHeader>
            <CardContent>
              <ScrollArea className="h-[600px]">
                <div className="space-y-4">
                  {recentSamples.map((sample) => (
                    <Card key={sample.id}>
                      <CardContent className="pt-6">
                        <div className="flex items-start justify-between">
                          <div className="space-y-2 flex-1">
                            <div className="flex items-center gap-2">
                              <FileWarning className="h-5 w-5 text-red-500" />
                              <span className="font-mono text-sm">{sample.fileName}</span>
                              <Badge variant={getThreatLevelColor(sample.threatLevel)}>
                                {sample.threatLevel}
                              </Badge>
                            </div>
                            
                            <div className="flex gap-4 text-sm text-muted-foreground">
                              <span>Family:  <strong>{sample.family}</strong></span>
                              <span>Type: {sample.fileType}</span>
                              <span>Size: {(sample.fileSize / 1024).toFixed(2)} KB</span>
                            </div>

                            <div className="flex flex-wrap gap-1">
                              {sample.tags.map((tag) => (
                                <Badge key={tag} variant="outline">{tag}</Badge>
                              ))}
                            </div>

                            <div className="space-y-1 pt-2">
                              <div className="flex items-center gap-2 text-xs font-mono">
                                <Hash className="h-3 w-3" />
                                <span className="text-muted-foreground">MD5:</span>
                                <span>{sample.hashes.md5}</span>
                              </div>
                              <div className="flex items-center gap-2 text-xs font-mono">
                                <Hash className="h-3 w-3" />
                                <span className="text-muted-foreground">SHA256:</span>
                                <span>{sample.hashes.sha256}</span>
                              </div>
                            </div>

                            <div className="text-xs text-muted-foreground">
                              First seen: {new Date(sample. firstSeen).toLocaleString()}
                            </div>
                          </div>

                          <Button onClick={() => handleAnalyze(sample)} variant="outline" size="sm">
                            <Brain className="mr-2 h-4 w-4" />
                            Analyze
                          </Button>
                        </div>
                      </CardContent>
                    </Card>
                  ))}
                </div>
              </ScrollArea>
            </CardContent>
          </Card>
        </TabsContent>

        {/* Search Results Tab */}
        <TabsContent value="search" className="space-y-4">
          <Card>
            <CardHeader>
              <CardTitle>Search Results</CardTitle>
              <CardDescription>
                {searchResults.length} result(s) found for "{searchQuery}"
              </CardDescription>
            </CardHeader>
            <CardContent>
              {searchResults.length === 0 ? (
                <Alert>
                  <AlertDescription>No results found.  Try a different search query.</AlertDescription>
                </Alert>
              ) : (
                <ScrollArea className="h-[600px]">
                  <div className="space-y-4">
                    {searchResults.map((sample) => (
                      <Card key={sample.id}>
                        <CardContent className="pt-6">
                          <div className="flex items-start justify-between">
                            <div className="space-y-2 flex-1">
                              <div className="flex items-center gap-2">
                                <FileWarning className="h-5 w-5 text-red-500" />
                                <span className="font-mono text-sm">{sample.fileName}</span>
                                <Badge variant={getThreatLevelColor(sample. threatLevel)}>
                                  {sample.threatLevel}
                                </Badge>
                              </div>
                              
                              <div className="flex gap-4 text-sm text-muted-foreground">
                                <span>Family: <strong>{sample.family}</strong></span>
                                <span>Type: {sample.fileType}</span>
                                <span>First Seen: {new Date(sample. firstSeen).toLocaleDateString()}</span>
                              </div>

                              <div className="flex flex-wrap gap-1">
                                {sample.tags.map((tag) => (
                                  <Badge key={tag} variant="outline">{tag}</Badge>
                                ))}
                              </div>

                              <Separator className="my-2" />

                              <div className="space-y-1">
                                <div className="flex items-center gap-2 text-xs font-mono">
                                  <Hash className="h-3 w-3" />
                                  <span className="text-muted-foreground">SHA256:</span>
                                  <span className="break-all">{sample.hashes.sha256}</span>
                                </div>
                              </div>
                            </div>

                            <Button onClick={() => handleAnalyze(sample)} variant="outline" size="sm">
                              <Brain className="mr-2 h-4 w-4" />
                              Analyze
                            </Button>
                          </div>
                        </CardContent>
                      </Card>
                    ))}
                  </div>
                </ScrollArea>
              )}
            </CardContent>
          </Card>
        </TabsContent>

        {/* Analysis Tab */}
        <TabsContent value="analysis" className="space-y-4">
          {! analysis ? (
            <Card>
              <CardContent className="pt-6">
                <Alert>
                  <AlertDescription>
                    Select a malware sample to analyze using AI-powered threat intelligence aggregation.
                  </AlertDescription>
                </Alert>
              </CardContent>
            </Card>
          ) : (
            <>
              <Card>
                <CardHeader>
                  <CardTitle className="flex items-center gap-2">
                    <Brain className="h-5 w-5" />
                    AI-Powered Malware Analysis
                  </CardTitle>
                  <CardDescription>{analysis.fileName}</CardDescription>
                </CardHeader>
                <CardContent className="space-y-6">
                  {/* Verdict */}
                  <div>
                    <h3 className="font-semibold mb-2 flex items-center gap-2">
                      <Shield className="h-4 w-4" />
                      Verdict
                    </h3>
                    <Alert>
                      <AlertTriangle className="h-4 w-4" />
                      <AlertDescription>
                        <div className="font-semibold">{analysis.verdict}</div>
                        <div className="text-sm text-muted-foreground mt-1">
                          Confidence: {(analysis.confidence * 100).toFixed(0)}%
                        </div>
                      </AlertDescription>
                    </Alert>
                  </div>

                  <Separator />

                  {/* Malware Family & Threat Actors */}
                  <div className="grid gap-4 md:grid-cols-2">
                    <div>
                      <h3 className="font-semibold mb-2">Malware Family</h3>
                      <Badge variant="destructive" className="text-base">
                        {analysis.malwareFamily}
                      </Badge>
                    </div>
                    <div>
                      <h3 className="font-semibold mb-2 flex items-center gap-2">
                        <Users className="h-4 w-4" />
                        Associated Threat Actors
                      </h3>
                      <div className="flex flex-wrap gap-2">
                        {analysis.threatActors.map((actor) => (
                          <Badge key={actor} variant="outline">{actor}</Badge>
                        ))}
                      </div>
                    </div>
                  </div>

                  <Separator />

                  {/* Capabilities */}
                  <div>
                    <h3 className="font-semibold mb-2">Capabilities</h3>
                    <div className="flex flex-wrap gap-2">
                      {analysis.capabilities.map((capability) => (
                        <Badge key={capability}>{capability}</Badge>
                      ))}
                    </div>
                  </div>

                  <Separator />

                  {/* IOCs */}
                  <div className="space-y-4">
                    <h3 className="font-semibold">Indicators of Compromise (IOCs)</h3>
                    
                    {analysis.iocs. ips.length > 0 && (
                      <div>
                        <h4 className="text-sm font-medium mb-2">IP Addresses</h4>
                        <div className="flex flex-wrap gap-2">
                          {analysis.iocs. ips.slice(0, 10).map((ip) => (
                            <Badge key={ip} variant="outline" className="font-mono">{ip}</Badge>
                          ))}
                          {analysis.iocs.ips.length > 10 && (
                            <Badge variant="secondary">+{analysis.iocs. ips.length - 10} more</Badge>
                          )}
                        </div>
                      </div>
                    )}

                    {analysis.iocs.domains.length > 0 && (
                      <div>
                        <h4 className="text-sm font-medium mb-2">Domains</h4>
                        <div className="flex flex-wrap gap-2">
                          {analysis.iocs.domains.slice(0, 10).map((domain) => (
                            <Badge key={domain} variant="outline" className="font-mono">{domain}</Badge>
                          ))}
                          {analysis.iocs.domains.length > 10 && (
                            <Badge variant="secondary">+{analysis. iocs.domains.length - 10} more</Badge>
                          )}
                        </div>
                      </div>
                    )}

                    {analysis. iocs.urls.length > 0 && (
                      <div>
                        <h4 className="text-sm font-medium mb-2">URLs</h4>
                        <ScrollArea className="h-32">
                          <div className="space-y-1">
                            {analysis.iocs.urls.map((url) => (
                              <div key={url} className="text-xs font-mono break-all p-2 bg-muted rounded">
                                {url}
                              </div>
                            ))}
                          </div>
                        </ScrollArea>
                      </div>
                    )}
                  </div>

                  <Separator />

                  {/* Behavior */}
                  <div>
                    <h3 className="font-semibold mb-2 flex items-center gap-2">
                      <Activity className="h-4 w-4" />
                      Behavior Patterns
                    </h3>
                    <ul className="space-y-1">
                      {analysis.behavior. map((behavior, index) => (
                        <li key={index} className="text-sm flex items-start gap-2">
                          <span className="text-muted-foreground mt-1">•</span>
                          <span>{behavior}</span>
                        </li>
                      ))}
                    </ul>
                  </div>

                  <Separator />

                  {/* YARA Rules */}
                  <div>
                    <h3 className="font-semibold mb-2">YARA Detection Rules</h3>
                    <ScrollArea className="h-48">
                      <pre className="text-xs bg-muted p-4 rounded font-mono">
                        {analysis.yara_rules. join('\n\n')}
                      </pre>
                    </ScrollArea>
                  </div>

                  <Separator />

                  {/* File Hashes */}
                  <div>
                    <h3 className="font-semibold mb-2 flex items-center gap-2">
                      <Hash className="h-4 w-4" />
                      File Hashes
                    </h3>
                    <div className="space-y-2 font-mono text-xs">
                      {analysis.iocs.fileHashes.map((hash) => (
                        <div key={hash} className="flex items-center gap-2">
                          <span className="text-muted-foreground">
                            {hash.length === 32 ? 'MD5:' : hash.length === 40 ? 'SHA1:' : 'SHA256:'}
                          </span>
                          <span className="break-all">{hash}</span>
                        </div>
                      ))}
                    </div>
                  </div>
                </CardContent>
              </Card>
            </>
          )}
        </TabsContent>
      </Tabs>
    </div>
  );
}
