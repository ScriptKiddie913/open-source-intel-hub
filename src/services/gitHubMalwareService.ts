// Real GitHub malware search service - NO MOCK DATA
// Searches for malware repositories and files using GitHub API

export interface GitHubRepository {
  id: string;
  name: string;
  full_name: string;
  description: string;
  html_url: string;
  created_at: string;
  updated_at: string;
  language: string;
  stargazers_count: number;
  forks_count: number;
  size: number;
  owner: {
    login: string;
    avatar_url: string;
  };
}

export interface GitHubFile {
  name: string;
  path: string;
  sha: string;
  url: string;
  html_url: string;
  repository: {
    full_name: string;
    html_url: string;
  };
}

export interface GitHubSearchResponse {
  total_count: number;
  items: GitHubRepository[] | GitHubFile[];
  incomplete_results: boolean;
}

class GitHubMalwareService {
  private readonly baseUrl = 'https://api.github.com';
  private readonly userAgent = 'OSINT-Hub/1.0';

  // Search for malware-related repositories
  async searchMalwareRepositories(query: string, limit: number = 50): Promise<GitHubRepository[]> {
    try {
      console.log(`[GitHub] Searching repositories for: ${query}`);
      
      const searchQuery = `${query} malware OR trojan OR backdoor OR virus OR exploit`;
      const response = await fetch(
        `${this.baseUrl}/search/repositories?q=${encodeURIComponent(searchQuery)}&sort=updated&per_page=${limit}`,
        {
          headers: {
            'User-Agent': this.userAgent,
            'Accept': 'application/vnd.github.v3+json'
          }
        }
      );

      if (!response.ok) {
        throw new Error(`GitHub API failed: ${response.status} ${response.statusText}`);
      }

      const data: GitHubSearchResponse = await response.json();
      console.log(`[GitHub] Found ${data.total_count} repositories, returning ${data.items.length}`);

      return data.items as GitHubRepository[];

    } catch (error) {
      console.error('[GitHub] Repository search failed:', error);
      throw new Error(`GitHub repository search failed: ${error.message}`);
    }
  }

  // Search for specific malware files
  async searchMalwareFiles(filename: string, extension: string = ''): Promise<GitHubFile[]> {
    try {
      console.log(`[GitHub] Searching files: ${filename}${extension}`);
      
      const searchQuery = `filename:${filename}${extension} malware OR trojan OR payload`;
      const response = await fetch(
        `${this.baseUrl}/search/code?q=${encodeURIComponent(searchQuery)}&per_page=50`,
        {
          headers: {
            'User-Agent': this.userAgent,
            'Accept': 'application/vnd.github.v3+json'
          }
        }
      );

      if (!response.ok) {
        throw new Error(`GitHub API failed: ${response.status}`);
      }

      const data: GitHubSearchResponse = await response.json();
      console.log(`[GitHub] Found ${data.total_count} files, returning ${data.items.length}`);

      return data.items as GitHubFile[];

    } catch (error) {
      console.error('[GitHub] File search failed:', error);
      throw new Error(`GitHub file search failed: ${error.message}`);
    }
  }

  // Search for APT group repositories
  async searchAPTRepositories(aptGroup: string): Promise<GitHubRepository[]> {
    try {
      console.log(`[GitHub] Searching APT repositories for: ${aptGroup}`);
      
      const searchQuery = `"${aptGroup}" OR "${aptGroup.replace(/\s+/g, '-')}" malware OR apt OR campaign`;
      const response = await fetch(
        `${this.baseUrl}/search/repositories?q=${encodeURIComponent(searchQuery)}&sort=stars&per_page=30`,
        {
          headers: {
            'User-Agent': this.userAgent,
            'Accept': 'application/vnd.github.v3+json'
          }
        }
      );

      if (!response.ok) {
        throw new Error(`GitHub API failed: ${response.status}`);
      }

      const data: GitHubSearchResponse = await response.json();
      console.log(`[GitHub] Found ${data.total_count} APT repositories for ${aptGroup}`);

      return data.items as GitHubRepository[];

    } catch (error) {
      console.error(`[GitHub] APT search for ${aptGroup} failed:`, error);
      throw error;
    }
  }

  // Search for YARA rules
  async searchYARARules(malwareFamily: string): Promise<GitHubFile[]> {
    try {
      console.log(`[GitHub] Searching YARA rules for: ${malwareFamily}`);
      
      const searchQuery = `"${malwareFamily}" extension:yar OR extension:yara`;
      const response = await fetch(
        `${this.baseUrl}/search/code?q=${encodeURIComponent(searchQuery)}&per_page=50`,
        {
          headers: {
            'User-Agent': this.userAgent,
            'Accept': 'application/vnd.github.v3+json'
          }
        }
      );

      if (!response.ok) {
        throw new Error(`GitHub YARA search failed: ${response.status}`);
      }

      const data: GitHubSearchResponse = await response.json();
      console.log(`[GitHub] Found ${data.total_count} YARA rules for ${malwareFamily}`);

      return data.items as GitHubFile[];

    } catch (error) {
      console.error(`[GitHub] YARA search for ${malwareFamily} failed:`, error);
      throw error;
    }
  }
}

export const gitHubMalwareService = new GitHubMalwareService();
