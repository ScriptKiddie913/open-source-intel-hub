// Malware Intelligence Service
// Simulated service for malware intelligence data

export interface MalwareReport {
  id: string;
  title: string;
  description: string;
  family: string;
  severity: 'critical' | 'high' | 'medium' | 'low';
  origin?: string;
  timestamp: Date;
  tags?: string[];
  iocs?: string[];
}

export interface MalwareFamily {
  name: string;
  description: string;
  threatLevel: 'critical' | 'high' | 'medium' | 'low';
  firstSeen: string;
  sampleCount: number;
  active: boolean;
  tactics?: string[];
}

export interface MalwareScanResult {
  threatLevel: 'critical' | 'high' | 'medium' | 'low' | 'clean';
  detections: number;
  totalEngines: number;
  family?: string;
  sha256?: string;
  fileSize?: number;
  fileType?: string;
  confidence: number;
}

// Mock data for demonstration
const mockMalwareReports: MalwareReport[] = [
  {
    id: "1",
    title: "New Ransomware Variant Targets Healthcare Sector",
    description: "A new variant of the Lockbit ransomware family has been observed targeting healthcare institutions across North America.",
    family: "Lockbit",
    severity: "critical",
    origin: "Russia",
    timestamp: new Date(Date.now() - 2 * 60 * 60 * 1000),
    tags: ["ransomware", "healthcare", "encryption", "exfiltration"],
    iocs: ["d4f2c5e8a9b1c3d4e5f6a7b8c9d0e1f2", "malicious.example.com"]
  },
  {
    id: "2",
    title: "Banking Trojan Campaign Using COVID-19 Themes",
    description: "Emotet botnet operators are distributing banking trojans through COVID-19 themed phishing emails.",
    family: "Emotet",
    severity: "high",
    origin: "Eastern Europe",
    timestamp: new Date(Date.now() - 6 * 60 * 60 * 1000),
    tags: ["banking", "trojan", "phishing", "covid-19"],
    iocs: ["b2d4f6e8a0c2e4f6a8b0c2d4e6f8a0b2"]
  },
  {
    id: "3",
    title: "APT Group Uses Zero-Day in Supply Chain Attack",
    description: "Advanced persistent threat group leverages previously unknown vulnerability in popular software.",
    family: "APT29",
    severity: "critical",
    origin: "Nation State",
    timestamp: new Date(Date.now() - 12 * 60 * 60 * 1000),
    tags: ["apt", "zero-day", "supply-chain", "espionage"],
    iocs: ["c1e3f5a7b9d1e3f5a7b9c1d3e5f7a9b1"]
  },
  {
    id: "4",
    title: "Cryptomining Malware Spreads via USB Devices",
    description: "New cryptomining malware variant spreads through infected USB devices targeting corporate networks.",
    family: "CoinMiner",
    severity: "medium",
    origin: "Unknown",
    timestamp: new Date(Date.now() - 18 * 60 * 60 * 1000),
    tags: ["cryptomining", "usb", "lateral-movement"],
    iocs: ["a0b2c4d6e8f0a2b4c6d8e0f2a4b6c8d0"]
  },
  {
    id: "5",
    title: "Mobile Malware Targets Banking Apps",
    description: "Android banking trojan disguised as legitimate apps steals banking credentials.",
    family: "Anubis",
    severity: "high",
    origin: "Brazil",
    timestamp: new Date(Date.now() - 24 * 60 * 60 * 1000),
    tags: ["mobile", "android", "banking", "credential-theft"],
    iocs: ["e9f1a3b5c7d9e1f3a5b7c9d1e3f5a7b9"]
  }
];

const mockMalwareFamilies: MalwareFamily[] = [
  {
    name: "Lockbit",
    description: "Ransomware-as-a-Service (RaaS) operation known for fast encryption and double extortion tactics.",
    threatLevel: "critical",
    firstSeen: "2019-09-01",
    sampleCount: 15420,
    active: true,
    tactics: ["Ransomware", "Data Exfiltration", "Lateral Movement"]
  },
  {
    name: "Emotet",
    description: "Banking trojan and botnet infrastructure used for malware distribution and credential theft.",
    threatLevel: "high",
    firstSeen: "2014-06-01",
    sampleCount: 28745,
    active: true,
    tactics: ["Banking Trojan", "Botnet", "Email Phishing"]
  },
  {
    name: "APT29",
    description: "Nation-state threat group associated with Russian intelligence services.",
    threatLevel: "critical",
    firstSeen: "2008-01-01",
    sampleCount: 892,
    active: true,
    tactics: ["Espionage", "Zero-day", "Supply Chain"]
  },
  {
    name: "CoinMiner",
    description: "Generic cryptocurrency mining malware family with various variants.",
    threatLevel: "medium",
    firstSeen: "2017-03-01",
    sampleCount: 45210,
    active: true,
    tactics: ["Cryptomining", "Resource Hijacking", "Persistence"]
  },
  {
    name: "Anubis",
    description: "Android banking trojan targeting mobile banking applications.",
    threatLevel: "high",
    firstSeen: "2017-07-01",
    sampleCount: 6834,
    active: false,
    tactics: ["Mobile Banking", "Credential Theft", "Overlay Attacks"]
  },
  {
    name: "TrickBot",
    description: "Modular banking trojan with extensive capabilities for financial fraud.",
    threatLevel: "high",
    firstSeen: "2016-10-01",
    sampleCount: 19567,
    active: false,
    tactics: ["Banking Trojan", "Credential Harvesting", "Network Reconnaissance"]
  }
];

interface MalwareIntelligenceRequest {
  timeframe: string;
  severity?: string;
}

export async function getMalwareIntelligence(params: MalwareIntelligenceRequest) {
  // Simulate API call delay
  await new Promise(resolve => setTimeout(resolve, 1000));

  // Filter by timeframe
  const now = new Date();
  let cutoffTime: Date;
  
  switch (params.timeframe) {
    case '24h':
      cutoffTime = new Date(now.getTime() - 24 * 60 * 60 * 1000);
      break;
    case '7d':
      cutoffTime = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
      break;
    case '30d':
      cutoffTime = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
      break;
    case '90d':
      cutoffTime = new Date(now.getTime() - 90 * 24 * 60 * 60 * 1000);
      break;
    default:
      cutoffTime = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
  }

  let filteredReports = mockMalwareReports.filter(report => report.timestamp >= cutoffTime);

  // Filter by severity if specified
  if (params.severity) {
    filteredReports = filteredReports.filter(report => report.severity === params.severity);
  }

  return {
    reports: filteredReports,
    families: mockMalwareFamilies,
    totalSamples: mockMalwareFamilies.reduce((sum, family) => sum + family.sampleCount, 0)
  };
}

export async function analyzeMalwareSample(
  type: 'file' | 'url' | 'hash',
  target: string
): Promise<MalwareScanResult> {
  // Simulate analysis delay
  await new Promise(resolve => setTimeout(resolve, 2000));

  // Generate mock scan results
  const detections = Math.floor(Math.random() * 65);
  const totalEngines = 65;
  
  let threatLevel: MalwareScanResult['threatLevel'];
  const detectionRatio = detections / totalEngines;

  if (detectionRatio > 0.7) threatLevel = 'critical';
  else if (detectionRatio > 0.5) threatLevel = 'high';
  else if (detectionRatio > 0.3) threatLevel = 'medium';
  else if (detectionRatio > 0.1) threatLevel = 'low';
  else threatLevel = 'clean';

  // Assign random family for detected samples
  const families = ["Lockbit", "Emotet", "CoinMiner", "TrickBot", "Anubis"];
  const family = detections > 0 ? families[Math.floor(Math.random() * families.length)] : undefined;

  return {
    threatLevel,
    detections,
    totalEngines,
    family,
    sha256: type === 'hash' ? target : generateRandomHash(),
    fileSize: type === 'file' ? Math.floor(Math.random() * 1024 * 1024) : undefined,
    fileType: type === 'file' ? ['exe', 'pdf', 'doc', 'zip'][Math.floor(Math.random() * 4)] : undefined,
    confidence: Math.random() * 0.4 + 0.6 // 0.6 - 1.0
  };
}

function generateRandomHash(): string {
  return Array.from({ length: 64 }, () => Math.floor(Math.random() * 16).toString(16)).join('');
}

// Real-world integration placeholders
export async function queryVirusTotal(hash: string) {
  // In a real implementation, this would call VirusTotal API
  // For now, return mock data
  return analyzeMalwareSample('hash', hash);
}

export async function queryHybridAnalysis(hash: string) {
  // In a real implementation, this would call Hybrid Analysis API
  return analyzeMalwareSample('hash', hash);
}

export async function getMalwareNews() {
  // In a real implementation, this would fetch from threat intel feeds
  // Such as MISP, AlienVault OTX, ThreatConnect, etc.
  return mockMalwareReports.slice(0, 5);
}