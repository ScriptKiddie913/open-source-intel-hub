// Real abuse.ch MalwareBazaar service - NO MOCK DATA
// Fetches live malware samples from abuse.ch

export interface MalwareSample {
  sha256_hash: string;
  md5_hash: string;
  file_name: string;
  file_type: string;
  signature: string;
  first_seen: string;
  origin_country: string;
  tags: string[];
}

export interface MalwareBazaarResponse {
  query_status: string;
  data: MalwareSample[];
  total_count: number;
}

class MalwareBazaarService {
  private readonly baseUrl = 'https://mb-api.abuse.ch/api/v1/';

  // Fetch recent malware samples from abuse.ch
  async fetchRecentSamples(limit: number = 100): Promise<MalwareBazaarResponse> {
    try {
      console.log('[MalwareBazaar] Fetching recent malware samples...');
      
      const response = await fetch(`${this.baseUrl}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'User-Agent': 'OSINT-Hub/1.0'
        },
        body: JSON.stringify({
          query: 'get_recent',
          selector: limit.toString()
        })
      });

      if (!response.ok) {
        throw new Error(`MalwareBazaar API failed: ${response.status} ${response.statusText}`);
      }

      const data = await response.json();
      console.log('[MalwareBazaar] Raw API response:', data);
      
      if (data.query_status !== 'ok') {
        throw new Error(`MalwareBazaar query failed: ${data.query_status}`);
      }

      console.log('[MalwareBazaar] Successfully fetched', data.data?.length || 0, 'real malware samples');
      
      return {
        query_status: data.query_status,
        data: data.data || [],
        total_count: data.data?.length || 0
      };

    } catch (error) {
      console.error('[MalwareBazaar] Failed to fetch malware samples:', error);
      throw new Error(`MalwareBazaar fetch failed: ${error.message}`);
    }
  }

  // Search for specific malware family samples
  async searchMalwareFamily(family: string): Promise<MalwareBazaarResponse> {
    try {
      console.log(`[MalwareBazaar] Searching for ${family} samples...`);
      
      const response = await fetch(`${this.baseUrl}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'User-Agent': 'OSINT-Hub/1.0'
        },
        body: JSON.stringify({
          query: 'get_taginfo',
          tag: family.toLowerCase(),
          limit: 50
        })
      });

      if (!response.ok) {
        throw new Error(`MalwareBazaar search failed: ${response.status}`);
      }

      const data = await response.json();
      
      if (data.query_status !== 'ok') {
        console.warn(`[MalwareBazaar] No samples found for ${family}`);
        return { query_status: 'ok', data: [], total_count: 0 };
      }

      console.log(`[MalwareBazaar] Found ${data.data?.length || 0} samples for ${family}`);
      
      return {
        query_status: data.query_status,
        data: data.data || [],
        total_count: data.data?.length || 0
      };

    } catch (error) {
      console.error(`[MalwareBazaar] Search for ${family} failed:`, error);
      throw error;
    }
  }
}

export const malwareBazaarService = new MalwareBazaarService();
